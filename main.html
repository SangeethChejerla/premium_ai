<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Explorer Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://js.puter.com/v2/"></script> <!-- Puter.js Library -->
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #5855eb;
            --primary-light: rgba(99, 102, 241, 0.1);
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --bg-chat: #0f0f0f;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: #27272a;
            --border-light: #3f3f46;
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            --glow: 0 0 20px rgba(99, 102, 241, 0.3);
            --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-text: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, var(--primary), transparent, var(--primary), transparent);
            animation: rotate 20s linear infinite;
            opacity: 0.03;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .sidebar.collapsed {
            width: 0;
            transform: translateX(-100%);
            padding: 0;
            border-right: none;
            overflow: hidden;
        }
         .sidebar.collapsed > * {
            display: none;
        }


        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--gradient-bg);
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .sidebar-header-content {
            position: relative;
            z-index: 1;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .app-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            font-weight: 400;
        }

        .sidebar-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .config-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-select option {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .system-prompt-section {
            background: var(--bg-tertiary);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .system-prompt-section:hover {
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .system-prompt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .system-prompt-title { 
            font-weight: 600;
            color: var(--text-primary);
        }

        .system-prompt-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .system-prompt-status.active {
            background: var(--success);
            color: white;
            animation: pulse 2s infinite;
        }

        .system-prompt-status.inactive {
            background: var(--bg-chat);
            color: var(--text-muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .system-prompt-textarea {
            width: 100%;
            min-height: 120px;
            max-height: 200px;
            padding: 1rem;
            background: var(--bg-chat);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
            transition: all 0.2s ease;
            font-family: inherit;
            line-height: 1.5;
        }

        .system-prompt-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .system-prompt-textarea::placeholder {
            color: var(--text-muted);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
         .btn-icon-only { /* Style for buttons that only contain an icon */
            padding: 0.75rem; /* Adjust padding for square-ish look */
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-chat);
            color: var(--text-primary);
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            fill: currentColor;
        }
        .btn .btn-icon { /* For icons inside buttons with text */
             margin-right: 0.5rem; /* Default spacing if text exists */
        }
        .btn-icon-only .btn-icon { /* For icon-only buttons, no margin needed */
            margin-right: 0;
        }


        .memory-stats {
            background: var(--bg-chat);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        .memory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .memory-item:last-child {
            border-bottom: none;
        }

        .memory-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .memory-value {
            font-weight: 600;
            color: var(--primary);
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 0; /* Prevent overflow issues */
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .chat-actions {
            display: flex;
            gap: 0.75rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--bg-chat);
            position: relative;
        }

        .message {
            margin-bottom: 2rem;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: var(--primary);
        }

        .message-avatar.assistant {
            background: var(--success);
        }

        .message-avatar.system {
            background: var(--warning);
        }
         .message-avatar.error { 
            background: var(--error);
        }

        .message-info {
            flex: 1;
        }

        .message-sender {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .message-model {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto; 
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-left: 0.5rem; 
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .copy-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
        }

        .copy-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .message-content {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden; 
             word-wrap: break-word;
        }

        .message.user .message-content {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .message.system .message-content { 
            background: rgba(245, 158, 11, 0.1); 
            border-color: var(--warning);
        }
         .message.error .message-content { 
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
        }


        /* Enhanced Markdown Styling */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            color: var(--text-primary);
            margin: 1.5rem 0 1rem 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .message-content h1 {
            font-size: 1.75rem; 
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .message-content h2 {
            font-size: 1.375rem; 
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .message-content h3 { font-size: 1.125rem; }
        .message-content h4 { font-size: 1rem; }
        .message-content h5 { font-size: 0.875rem; }
        .message-content h6 { font-size: 0.75rem; }

        .message-content p {
            margin: 1rem 0;
            line-height: 1.6;
            color: var(--text-primary);
        }
        .message-content p:first-child { margin-top: 0; }
        .message-content p:last-child { margin-bottom: 0; }


        .message-content ul,
        .message-content ol {
            margin: 1rem 0 1rem 1.5rem;
            line-height: 1.6;
            padding-left: 1.5rem; 
        }

        .message-content ul li,
        .message-content ol li {
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        .message-content blockquote {
            border-left: 4px solid var(--primary);
            margin: 1.5rem 0;
            padding: 1rem 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 0 0.5rem 0.5rem 0;
            font-style: italic;
            color: var(--text-secondary);
        }
         .message-content blockquote p {
            margin: 0.5rem 0; 
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .message-content th,
        .message-content td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-content td {
            color: var(--text-secondary);
        }

        .message-content tr:last-child td {
            border-bottom: none;
        }

        /* Enhanced Code Block Styling */
        .message-content pre {
            background: #1e1e1e !important; 
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            margin: 1.5rem 0;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
        }

        .code-header {
            background: #2d2d2d;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .code-language {
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary);
        }

        .code-copy-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .code-copy-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .code-copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .message-content pre code.hljs { 
            display: block;
            padding: 1.5rem !important; 
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.5;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            background: transparent !important; 
            color: #d4d4d4 !important; 
        }

        .message-content :not(pre) > code { 
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875em; 
            color: var(--primary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        /* Input Area */
        .input-area {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            max-width: 100%;
            position: relative;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            min-height: 3rem; 
            max-height: 8rem; 
            padding: 0.75rem 3.5rem 0.75rem 1rem; 
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: none;
            transition: all 0.2s ease;
            font-family: inherit;
            line-height: 1.5;
            overflow-y: hidden; 
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            position: absolute;
            right: 0.75rem;
            bottom: 0.65rem; 
            display: flex;
            gap: 0.5rem;
        }

        .input-btn {
            width: 2.25rem; 
            height: 2.25rem;
            border: none;
            border-radius: 0.75rem; 
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .input-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }

        .input-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading-indicator {
            display: none; 
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem; 
        }

        .loading-indicator.active {
            display: flex;
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 1rem; 
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; 
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            box-shadow: var(--shadow-xl);
            animation: toastSlideInUp 0.3s ease;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            min-width: 250px;
        }

        .toast.success {
            border-left: 4px solid var(--success); 
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        @keyframes toastSlideInUp { 
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
         @keyframes toastFadeOut {
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }


        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 200; 
                width: 280px; 
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }
             .chat-header, .input-area {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .chat-messages {
                padding: 1rem;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 0.5rem;
            height: 0.5rem;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 0.25rem;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <h1 class="app-title">AI Chat Explorer</h1>
                    <p class="app-subtitle">Advanced Conversational AI</p>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="config-section">
                    <h3 class="section-title">Model Configuration</h3>
                    <div class="form-group">
                        <label class="form-label" for="model-select">AI Model</label>
                        <select id="model-select" class="form-select">
                            <option value="claude-3-7-sonnet">Anthropic Claude 3.7 Sonnet</option>
                             <option value="claude-sonnet-4-latest">Anthropic Claude 4 Sonnet</option>
                              <option value="claude-opus-4-latest">Anthropic Claude 4 opus</option>
                            <option value="openrouter:openai/o4-mini-high">OpenAI o4-mini-high</option>
                            <option value="openrouter:openai/o3">OpenAI O3</option>
                            <option value="openrouter:openai/gpt-4.5-preview">OpenAI GPT-4.5 Preview</option>
                            <option value="openrouter:openai/codex-mini">OpenAI Codex Mini</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <h3 class="section-title">System Prompt</h3>
                    <div class="system-prompt-section">
                        <div class="system-prompt-header">
                            <span class="system-prompt-title">Custom Instructions</span>
                            <span id="system-prompt-status" class="system-prompt-status inactive">Inactive</span>
                        </div>
                        <textarea 
                            id="system-prompt-textarea" 
                            class="system-prompt-textarea"
                            placeholder="Define the AI's behavior, personality, and response style. For example: 'You are a helpful programming assistant. Always provide code examples and explain your reasoning step by step.'"
                        ></textarea>
                        <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                            <button id="save-system-prompt" class="btn btn-primary" style="flex: 1;">
                                <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                                Save
                            </button>
                            <button id="clear-system-prompt-btn" class="btn btn-secondary"> 
                                <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                                     <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h3 class="section-title">Memory & Statistics</h3>
                    <div class="memory-stats">
                        <div class="memory-item">
                            <span class="memory-label">Messages</span>
                            <span id="message-count" class="memory-value">0</span>
                        </div>
                        <div class="memory-item">
                            <span class="memory-label">Tokens (Est.)</span>
                            <span id="token-count" class="memory-value">0</span>
                        </div>
                        <div class="memory-item">
                            <span class="memory-label">Session Duration</span>
                            <span id="session-duration" class="memory-value">0m</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <button id="clear-chat-btn" class="btn btn-danger" style="width: 100%;"> 
                        <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Clear Chat & Prompt
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <h2 class="chat-title">
                    <button class="sidebar-toggle" id="sidebar-toggle">â˜°</button>
                    Conversation
                </h2>
                <div class="chat-actions">
                    <!-- Fullscreen Button START -->
                    <button id="toggle-fullscreen-btn" class="btn btn-secondary btn-icon-only" title="Toggle Fullscreen">
                        <svg id="fullscreen-icon-enter" class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 2h2v3h-3v2h5v-5h-2zm-3-2V5h-2v5h5V7h-3z"/>
                        </svg>
                        <svg id="fullscreen-icon-exit" class="btn-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                        </svg>
                    </button>
                    <!-- Fullscreen Button END -->
                    <button id="export-chat-btn" class="btn btn-secondary"> 
                        <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Export
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <!-- Messages will be dynamically inserted here -->
            </div>

            <div class="input-area">
                <div class="loading-indicator" id="loading-indicator">
                    <div class="spinner"></div>
                    <span>AI is thinking...</span>
                </div>
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="message-input" 
                            class="message-input" 
                            placeholder="Type your message here... (Ctrl+Enter to send, Shift+Enter for new line)"
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <button id="send-btn" class="input-btn" title="Send message (Ctrl+Enter)">
                                <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Application State
        const AppState = {
            messages: [],
            systemPrompt: '',
            currentModel: 'claude-3-7-sonnet', // Default model
            sessionStartTime: Date.now(),
            isLoading: false,
            sidebarCollapsed: window.innerWidth < 768 // Collapse by default on mobile
        };

        // DOM Elements
        const elements = {
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle'),
            chatMessages: document.getElementById('chat-messages'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            loadingIndicator: document.getElementById('loading-indicator'),
            modelSelect: document.getElementById('model-select'),
            systemPromptTextarea: document.getElementById('system-prompt-textarea'),
            systemPromptStatus: document.getElementById('system-prompt-status'),
            saveSystemPrompt: document.getElementById('save-system-prompt'),
            clearSystemPromptBtn: document.getElementById('clear-system-prompt-btn'),
            clearChatBtn: document.getElementById('clear-chat-btn'),
            exportChatBtn: document.getElementById('export-chat-btn'),
            messageCount: document.getElementById('message-count'),
            tokenCount: document.getElementById('token-count'),
            sessionDuration: document.getElementById('session-duration'),
            toastContainer: document.getElementById('toast-container'),
            // Fullscreen Functionality START
            toggleFullscreenBtn: document.getElementById('toggle-fullscreen-btn'),
            fullscreenIconEnter: document.getElementById('fullscreen-icon-enter'),
            fullscreenIconExit: document.getElementById('fullscreen-icon-exit')
            // Fullscreen Functionality END
        };

        // Utility Functions
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function estimateTokens(text) {
            if (!text) return 0;
            return Math.ceil(text.length / 4); // Rough estimation
        }

        function updateSessionDuration() {
            const durationSeconds = Math.floor((Date.now() - AppState.sessionStartTime) / 1000);
            const minutes = Math.floor(durationSeconds / 60);
            const seconds = durationSeconds % 60;
            elements.sessionDuration.textContent = `${minutes}m ${seconds}s`;
        }

        function updateStats() {
            elements.messageCount.textContent = AppState.messages.length;
            const totalTokens = AppState.messages.reduce((sum, msg) => 
                sum + estimateTokens(msg.content), 0) + estimateTokens(AppState.systemPrompt);
            elements.tokenCount.textContent = totalTokens.toLocaleString();
            updateSessionDuration();
        }
        setInterval(updateSessionDuration, 1000); // Update duration every second


        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            elements.toastContainer.appendChild(toast); 
            
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function toggleSidebar() {
            AppState.sidebarCollapsed = !AppState.sidebarCollapsed;
            elements.sidebar.classList.toggle('collapsed', AppState.sidebarCollapsed);
        }
        
        async function copyToClipboard(text, feedbackElement) {
            try {
                await navigator.clipboard.writeText(text);
                if (feedbackElement) {
                    const originalText = feedbackElement.innerHTML;
                    feedbackElement.classList.add('copied');
                    feedbackElement.innerHTML = `
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                        </svg>
                        Copied
                    `;
                    setTimeout(() => {
                        feedbackElement.classList.remove('copied');
                        feedbackElement.innerHTML = originalText;
                    }, 1500);
                }
                return true;
            } catch (err) {
                console.error('Failed to copy:', err);
                showToast('Failed to copy to clipboard.', 'error');
                return false;
            }
        }

        function copyMessage(button) {
            const messageContentElement = button.closest('.message').querySelector('.message-content');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = messageContentElement.innerHTML; 
            tempDiv.querySelectorAll('pre').forEach(pre => pre.remove());
            
            let textToCopy = "";
            tempDiv.innerHTML = tempDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');
            tempDiv.querySelectorAll('p, li, h1, h2, h3, h4, h5, h6').forEach(el => {
                textToCopy += el.textContent + '\n';
            });
            if (!textToCopy) textToCopy = tempDiv.textContent || tempDiv.innerText; 
            
            copyToClipboard(textToCopy.trim(), button).then(success => {
                if (success) showToast('Message copied!');
            });
        }

        function copyCode(button) {
            const codeBlock = button.closest('pre').querySelector('code');
            const text = codeBlock.textContent || codeBlock.innerText;
            copyToClipboard(text, button).then(success => {
                if (success) showToast('Code copied!');
            });
        }
        
        window.copyMessage = copyMessage; 
        window.copyCode = copyCode;     

        function renderMarkdown(text) {
            if (!text) return '';
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                },
                breaks: true,
                gfm: true,
                pedantic: false,
                sanitize: false 
            });

            let html = marked.parse(text);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            tempDiv.querySelectorAll('pre').forEach(preElement => {
                const codeElement = preElement.querySelector('code');
                let lang = 'plaintext';
                if (codeElement && codeElement.className.startsWith('language-')) {
                    lang = codeElement.className.replace('language-', '');
                }
                
                const header = document.createElement('div');
                header.className = 'code-header';
                header.innerHTML = `
                    <span class="code-language">${lang}</span>
                    <button class="code-copy-btn" onclick="copyCode(this)">
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                        </svg>
                        Copy
                    </button>
                `;
                preElement.insertBefore(header, codeElement);
                if(codeElement) codeElement.classList.add('hljs'); 
            });
            
            return DOMPurify.sanitize(tempDiv.innerHTML, { ADD_TAGS: ["kbd"], KEEP_CONTENT: true });
        }

        function addMessage(role, content, model = null) {
            const timestamp = Date.now();
            const message = { role, content, timestamp, model };
            AppState.messages.push(message);

            const messageElement = createMessageElement(message);
            elements.chatMessages.appendChild(messageElement);
            
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            updateStats();
            return messageElement;
        }

        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.role}`;

            const avatarMap = { user: 'YOU', assistant: 'AI', system: 'SYS', error: 'ERR' };
            const senderName = message.role.charAt(0).toUpperCase() + message.role.slice(1);
            
            let modelNameDisplay = '';
            if (message.role === 'assistant' && message.model) {
                modelNameDisplay = message.model.replace('openrouter:', '').replace('claude-3-7-sonnet', 'Claude 3.7 Sonnet').split('/').pop();
            } else if (message.role === 'system' && message.model) {
                modelNameDisplay = message.model; 
            }

            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${message.role}">${avatarMap[message.role] || '??'}</div>
                    <div class="message-info">
                        <div class="message-sender">${senderName}</div>
                        ${modelNameDisplay ? `<div class="message-model">${modelNameDisplay}</div>` : ''}
                    </div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                    <div class="message-actions">
                        <button class="copy-btn" onclick="copyMessage(this)">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                            Copy
                        </button>
                    </div>
                </div>
                <div class="message-content">
                    ${message.role === 'user' ? 
                        DOMPurify.sanitize(message.content.replace(/\n/g, '<br>')) : 
                        renderMarkdown(message.content)
                    }
                </div>
            `;
            messageDiv.querySelectorAll('pre code').forEach(hljs.highlightElement);
            return messageDiv;
        }

        async function sendMessageHandler() {
            const content = elements.messageInput.value.trim();
            if (!content || AppState.isLoading) return;

            addMessage('user', content);
            elements.messageInput.value = '';
            autoResizeTextarea();

            AppState.isLoading = true;
            elements.loadingIndicator.classList.add('active');
            elements.sendBtn.disabled = true;
            elements.messageInput.disabled = true;

            try {
                const apiMessagesForHistory = [];
                if (AppState.systemPrompt) {
                    apiMessagesForHistory.push({ role: 'system', content: AppState.systemPrompt });
                }

                AppState.messages
                    .filter(m => (m.role === 'user' || m.role === 'assistant') && m !== AppState.messages[AppState.messages.length -1] ) 
                    .forEach(msg => {
                        apiMessagesForHistory.push({ role: msg.role, content: msg.content });
                    });
                
                console.log("Sending to Puter.ai with history:", apiMessagesForHistory);
                console.log("Current prompt:", content);
                console.log("Model:", AppState.currentModel);

                const apiOptions = { model: AppState.currentModel, max_tokens: 8192 };
                 if (apiMessagesForHistory.length > 0) {
                    apiOptions.messages = apiMessagesForHistory;
                }

                const response = await puter.ai.chat(content, apiOptions); 
                console.log("Puter.ai response:", response);

                let responseContent = '';
                let successfullyParsed = false;

                if (response?.message?.content) {
                    if (Array.isArray(response.message.content) && response.message.content.length > 0 && typeof response.message.content[0].text === 'string') {
                        responseContent = response.message.content.map(block => block.text).join('\n\n'); 
                        successfullyParsed = true;
                    } else if (typeof response.message.content === 'string') { 
                        responseContent = response.message.content;
                        successfullyParsed = true;
                    } else {
                         responseContent = `Received an unexpected content format from the AI. Please check the browser console for details.`;
                         console.error("Unexpected AI response content format:", response.message.content);
                    }
                } else if (response?.error) {
                    responseContent = `AI Error: ${response.error.message || response.error.code || 'Unknown error'}`;
                    console.error("AI Error:", response.error);
                }
                 else {
                    responseContent = `Received an empty or invalid response from the AI. Please check the browser console.`;
                    console.error("Empty/invalid AI response:", response);
                }
                
                if (successfullyParsed && responseContent) {
                    addMessage('assistant', responseContent, AppState.currentModel);
                } else {
                    addMessage('error', `Error from ${AppState.currentModel.split('/').pop()}: ${responseContent}`, 'System Error'); // Use 'error' role
                    showToast(responseContent, 'error', 5000);
                }

            } catch (error) {
                console.error('API Error:', error);
                const errorMsg = `API Error with ${AppState.currentModel.split('/').pop() || 'model'}: ${error.message || 'Unknown error'}. Check console.`;
                addMessage('error', errorMsg, 'System Error'); // Use 'error' role
                showToast(errorMsg, 'error', 5000);
            } finally {
                AppState.isLoading = false;
                elements.loadingIndicator.classList.remove('active');
                elements.sendBtn.disabled = false;
                elements.messageInput.disabled = false;
                elements.messageInput.focus();
            }
        }

        function autoResizeTextarea() {
            const textarea = elements.messageInput;
            textarea.style.height = 'auto'; 
            const scrollHeight = textarea.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(textarea).maxHeight, 10);
            
            if (scrollHeight > maxHeight) {
                textarea.style.height = `${maxHeight}px`;
                textarea.style.overflowY = 'auto';
            } else {
                textarea.style.height = `${scrollHeight}px`;
                textarea.style.overflowY = 'hidden';
            }
        }

        function updateSystemPromptStatus() {
            if (AppState.systemPrompt) {
                elements.systemPromptStatus.textContent = 'Active';
                elements.systemPromptStatus.classList.remove('inactive');
                elements.systemPromptStatus.classList.add('active');
            } else {
                elements.systemPromptStatus.textContent = 'Inactive';
                elements.systemPromptStatus.classList.remove('active');
                elements.systemPromptStatus.classList.add('inactive');
            }
        }

        function handleSaveSystemPrompt() {
            AppState.systemPrompt = elements.systemPromptTextarea.value.trim();
            updateSystemPromptStatus();
            updateStats(); 
            showToast('System prompt saved!');
        }

        function handleClearSystemPrompt() {
            elements.systemPromptTextarea.value = '';
            AppState.systemPrompt = '';
            updateSystemPromptStatus();
            updateStats();
            showToast('System prompt editor cleared.');
        }
        
        function handleClearChat() {
            AppState.messages = [];
            elements.chatMessages.innerHTML = ''; 
            
            AppState.systemPrompt = ''; 
            elements.systemPromptTextarea.value = '';
            updateSystemPromptStatus();
            
            addMessage('system',
                `Chat history and custom instructions have been cleared.
                <p>Configure your AI model and system prompt (optional), then start a new conversation!</p>`,
                'System Reset'
            );
            updateStats(); 
            showToast('Chat history & system prompt cleared.');
            elements.messageInput.focus();
        }

        function exportChatToMarkdown() {
            let markdown = `# AI Chat Export - ${new Date().toLocaleString()}\n\n`;
            markdown += `**Model Used Most Recently:** ${AppState.currentModel.replace('openrouter:', '').replace('claude-3-7-sonnet', 'Claude 3.7 Sonnet').split('/').pop()}\n`;
            if (AppState.systemPrompt) {
                markdown += `**System Prompt (at time of export):**\n\`\`\`\n${AppState.systemPrompt}\n\`\`\`\n\n`;
            }
            markdown += "---\n\n";

            AppState.messages.forEach(msg => {
                const sender = msg.role.charAt(0).toUpperCase() + msg.role.slice(1);
                let modelInfo = '';
                if (msg.role === 'assistant' && msg.model) {
                    modelInfo = ` (${msg.model.replace('openrouter:', '').replace('claude-3-7-sonnet', 'Claude 3.7 Sonnet').split('/').pop()})`;
                } else if ( (msg.role === 'system' || msg.role === 'error') && msg.model) {
                     modelInfo = ` (${msg.model})`;
                }
                
                markdown += `**${sender}${modelInfo}** (_${formatTime(msg.timestamp)}_):\n\n`;
                const contentToExport = msg.content;
                contentToExport.split('\n').forEach(line => {
                     markdown += `${line}\n`; 
                });
                markdown += `\n---\n\n`;
            });

            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-chat-export-${Date.now()}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Chat exported as Markdown!');
        }

        // Fullscreen Functionality START
        function isFullscreen() {
            return !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
        }

        function requestAppFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
        }

        function exitAppFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }

        function toggleAppFullscreen() {
            if (isFullscreen()) {
                exitAppFullscreen();
            } else {
                requestAppFullscreen();
            }
        }

        function updateFullscreenButton() {
            if (isFullscreen()) {
                elements.fullscreenIconEnter.style.display = 'none';
                elements.fullscreenIconExit.style.display = 'inline-block';
                elements.toggleFullscreenBtn.title = 'Exit Fullscreen';
            } else {
                elements.fullscreenIconEnter.style.display = 'inline-block';
                elements.fullscreenIconExit.style.display = 'none';
                elements.toggleFullscreenBtn.title = 'Enter Fullscreen';
            }
        }
        // Fullscreen Functionality END


        // Event Listeners
        function setupEventListeners() {
            elements.sidebarToggle.addEventListener('click', toggleSidebar);
            elements.sendBtn.addEventListener('click', sendMessageHandler);
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey && !e.metaKey) { 
                    if (window.innerWidth < 768) {
                         e.preventDefault();
                         sendMessageHandler();
                    }
                }
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    sendMessageHandler();
                }
            });
            elements.messageInput.addEventListener('input', autoResizeTextarea);
            
            elements.modelSelect.addEventListener('change', (e) => {
                AppState.currentModel = e.target.value;
                showToast(`Model changed to ${AppState.currentModel.split('/').pop()}`);
            });

            elements.saveSystemPrompt.addEventListener('click', handleSaveSystemPrompt);
            elements.clearSystemPromptBtn.addEventListener('click', handleClearSystemPrompt);
            elements.clearChatBtn.addEventListener('click', handleClearChat);
            elements.exportChatBtn.addEventListener('click', exportChatToMarkdown);

            // Fullscreen Functionality START
            if(elements.toggleFullscreenBtn) { // Ensure button exists
                elements.toggleFullscreenBtn.addEventListener('click', toggleAppFullscreen);
                document.addEventListener('fullscreenchange', updateFullscreenButton);
                document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
                document.addEventListener('mozfullscreenchange', updateFullscreenButton);
                document.addEventListener('MSFullscreenChange', updateFullscreenButton);
            }
            // Fullscreen Functionality END
        }

        // Initialization
        function init() {
            elements.modelSelect.value = AppState.currentModel;
            updateSystemPromptStatus();
            if (AppState.sidebarCollapsed) {
                 elements.sidebar.classList.add('collapsed');
            }
            
            addMessage('system',
                `Welcome to <strong>AI Chat Explorer</strong>! ðŸš€
                <p>Configure your preferred AI model and system prompt from the sidebar, then start chatting. Your conversation history will be maintained.</p>
                <h3>Quick Tips:</h3>
                <ul>
                    <li>Use <kbd>Ctrl+Enter</kbd> (or <kbd>Cmd+Enter</kbd>) to send messages.</li>
                    <li>The sidebar (â˜°) contains model settings and system prompt controls.</li>
                    <li>Code blocks will be syntax highlighted and have a copy button.</li>
                </ul>`,
                'System Welcome'
            );
            updateStats(); 
            setupEventListeners();
            autoResizeTextarea(); 
            // Fullscreen Functionality START
            if(elements.toggleFullscreenBtn) updateFullscreenButton(); // Set initial fullscreen button state
            // Fullscreen Functionality END
            elements.messageInput.focus();
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
